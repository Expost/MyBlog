---
title: MaoXian web clipperæ’ä»¶è£å‰ªç»“æœè‡ªå®šä¹‰å¤„ç†
date: 2020-03-25T00:42:35+08:00
categories: [çç¢]
---


# èƒŒæ™¯

æœ€è¿‘æœ‰å°†ç½‘é¡µå‰ªè—æˆmarkdownæ ¼å¼å¹¶åœ¨æœ¬åœ°è‡ªå®šä¹‰å¤„ç†çš„éœ€æ±‚ï¼Œç ”ç©¶äº†å‡ ä¸ªå¸¸ç”¨çš„[å‰ªè—æ’ä»¶](https://renyili.org/post/backup_web_pages/)ã€‚æœ€ç»ˆè®¤ä¸º[Maoxian Web Clipper](https://chrome.google.com/webstore/detail/maoxian-web-clipper/kjahokgdcbohofgdidndeiaigkehdjdc)æ’ä»¶æ¯”è¾ƒæ»¡è¶³è‡ªå·±çš„éœ€æ±‚ã€‚

Maoxianæ’ä»¶å¯ä»¥ç›´æ¥å°†å‰ªè—çš„ç½‘é¡µä¸‹è½½åˆ°æµè§ˆå™¨çš„ä¸‹è½½ç›®å½•ä¸‹ï¼Œå¹¶æŒ‰ç…§ä¸€å®šçš„ç›®å½•ç»“æ„è¿›è¡Œå­˜å‚¨ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªéº»çƒ¦ç‚¹ï¼Œå³ä¿å­˜çš„ç›®å½•æ˜¯åœ¨æµè§ˆå™¨çš„ä¸‹è½½ç›®å½•ä¸‹çš„ï¼Œä¸æµè§ˆå™¨ä¸‹è½½çš„å…¶ä»–æ–‡ä»¶æ…åˆåœ¨ä¸€èµ·ï¼Œä¸æ–¹ä¾¿ç®¡ç†ã€‚

ä¸ºæ­¤Maoxianæ’ä»¶æä¾›äº†ä¸€ä¸ªæœ¬åœ°ç¨‹åºï¼Œå¯ä»¥å°†å‰ªè—çš„ç»“æœå­˜æ”¾åˆ°å…¶ä»–åœ°æ–¹ï¼ŒåŒæ—¶è¿˜æä¾›äº†å¯¹å‰ªè—å†å²çš„ç®¡ç†åŠŸèƒ½ã€‚è¿™ä¸ªæœ¬åœ°ç¨‹åºä½¿ç”¨rubyå®ç°ï¼Œé‡‡ç”¨native messagingçš„æ–¹å¼ä¸æµè§ˆå™¨è¿›è¡Œé€šä¿¡ã€‚

è‡ªå·±éœ€è¦å¯¹å‰ªè—ä¸‹æ¥çš„markdownæ ¼å¼çš„æ–‡ä»¶åšä¸€äº›è‡ªå®šä¹‰å¤„ç†ï¼Œè€Œè¿™äº›åŠŸèƒ½æ— æ³•é€šè¿‡maoxianæ’ä»¶æœ¬èº«å®ç°ï¼Œä½†ç»è¿‡ç ”ç©¶ï¼Œå‘ç°å¯ä»¥åˆ©ç”¨è¿™ä¸ªæœ¬åœ°ç¨‹åºä¸æ’ä»¶çš„äº¤äº’æœºåˆ¶æ¥å®ç°ç»“æœçš„è‡ªå®šä¹‰å¤„ç†ã€‚

# æœ¬åœ°ç¨‹åºä»‹ç»

é¦–å…ˆéœ€è¦å‚è€ƒ[å®˜æ–¹è¯´æ˜](https://mika-cn.github.io/maoxian-web-clipper/native-app/index-zh-CN.html)å®‰è£…æœ¬åœ°ç¨‹åºã€‚**æˆ‘çš„ç¯å¢ƒæ˜¯Windows+Chromeï¼Œä»¥ä¸‹è¯´æ˜ä»¥æ­¤ç¯å¢ƒä¸ºå‡†**ã€‚

åœ¨è¿è¡Œæœ¬åœ°ç¨‹åºç›®å½•ä¸‹çš„`install.bat`ç¨‹åºåï¼Œä¼šæŠŠé…ç½®`manifest.json`å†™åˆ°æ³¨å†Œè¡¨ä¸­ï¼Œåœ¨`manifest.json`ä¸­é…ç½®äº†ä¸æ’ä»¶å…³è”çš„æœ¬åœ°ç¨‹åºè·¯å¾„ï¼Œä»¥åŠä¸æœ¬åœ°ç¨‹åºé€šä¿¡çš„æ–¹å¼ï¼ˆç›®å‰åªæœ‰stdioè¿™ä¸€ç§æ–¹å¼ï¼‰ã€‚è¿™é‡Œé…ç½®çš„æœ¬åœ°ç¨‹åºè·¯å¾„æ˜¯ç›®å½•ä¸‹çš„`app_loader.bat`ï¼Œè€Œè¯¥batä¸­å®é™…æ‰§è¡Œçš„æ˜¯rubyä»£ç `main.rb`ã€‚

è™½ç„¶ä¸ä¼šrubyï¼Œä½†å¤§è‡´çœ‹ä¸€ä¸‹ä¹Ÿèƒ½äº†è§£å…¶å«ä¹‰ï¼Œä¸æµè§ˆå™¨æ’ä»¶çš„é€šä¿¡é€»è¾‘ä¸»è¦åœ¨`lib\application.rb`æ–‡ä»¶ä¸­ã€‚æ¶ˆæ¯çš„æ¥æ”¶å’Œå‘é€ä»£ç åˆ™åœ¨`lib\native_message.rb`æ–‡ä»¶ä¸­ã€‚é€šè¿‡æ³¨é‡Šå¯ä»¥äº†è§£åˆ°ä¸Šä¸‹è¡Œåè®®æ ¼å¼å¾ˆç®€å•ã€‚

```ruby
# 32ä½çš„é•¿åº¦ + utf8ç¼–ç çš„jsonæ•°æ®
32bit(messageÂ length)Â +Â message(utf8Â encodedÂ json)
```

é€šä¿¡è¿‡ç¨‹ä¸­ï¼Œæœ¬åœ°ç¨‹åºä½œä¸ºæœåŠ¡ç«¯è¿è¡Œï¼Œç”±æµè§ˆå™¨æ’ä»¶å‘æœ¬åœ°ç¨‹åºå‘é€è¯·æ±‚ï¼Œæœ¬åœ°ç¨‹åºæ‰§è¡Œç›¸åº”æ“ä½œåï¼Œè¿”å›ç»“æœã€‚

ä¼ é€’çš„jsonæ•°æ®å¯ä»¥åœ¨å¼€å¯ç¨‹åºçš„debugæ¨¡å¼åä»logä¸­æŸ¥çœ‹ï¼Œå¼€å¯debugçš„æ–¹å¼æ˜¯ä¿®æ”¹`config.yaml`é…ç½®ä¸­çš„`environment`å­—æ®µä¸º`development`ã€‚

æµè§ˆå™¨ä¼šå‘æœ¬åœ°ç¨‹åºå‘é€6ç§ç±»å‹çš„è¯·æ±‚ï¼Œåˆ†åˆ«æ˜¯ï¼š

1. get.versionï¼Œè·å–æœ¬åœ°ç¨‹åºç‰ˆæœ¬å·ã€‚
2. get.downloadFolderï¼Œè·å–é…ç½®ä¸­æŒ‡å®šçš„æ–‡ä»¶ä¿å­˜ç›®å½•ã€‚
3. download.textï¼Œä¸‹è½½å‰ªè—æ–‡æœ¬ã€‚æ’ä»¶ä¼šå°†æ–‡æœ¬æ•°æ®ä¼ é€’ç»™æœ¬åœ°ç¨‹åºï¼Œç”±æœ¬åœ°ç¨‹åºå­˜å‚¨åˆ°é…ç½®æŒ‡å®šçš„ç›®å½•ä¸‹ã€‚è¿™é‡Œçš„æ–‡æœ¬åŒ…æ‹¬å‰ªè—çš„htmlæˆ–æ˜¯markdownæ–‡æœ¬ã€‚
4.  download.urlï¼Œä¸‹è½½é“¾æ¥ã€‚æ’ä»¶å°†å‰ªè—æ–‡æœ¬ä¸­çš„å›¾ç‰‡é“¾æ¥ç»™åˆ°æœ¬åœ°ç¨‹åºï¼Œç”±æœ¬åœ°ç¨‹åºä¸‹è½½ä¹‹åä¿å­˜ã€‚
5.  clipping.op.deleteï¼Œåˆ é™¤å‰ªè—ç»“æœã€‚
6.  history.refreshï¼Œåˆ·æ–°å‰ªè—å†å²ã€‚

å¦‚æœä¼šrubyï¼Œé‚£ä¹ˆç›´æ¥ä¿®æ”¹æœ¬åœ°ç¨‹åºçš„ä»£ç å³å¯æ»¡è¶³è‡ªå·±çš„éœ€æ±‚ï¼Œç„¶è€Œè‡ªå·±å¹¶ä¸ä¼šrubyï¼ŒæŸ¥äº†ä¸‹Pythonä¹Ÿæœ‰native messagingé€šä¿¡çš„[åº“](https://pypi.org/project/nativemessaging/)ï¼Œçœ‹äº†ä¸‹ç”¨æ³•ï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿå¾ˆç®€å•ï¼Œæ—¢ç„¶é€šä¿¡çš„åè®®çŸ¥é“äº†ï¼Œæ”¶å‘åŒ…ä¹Ÿæ”¯æŒäº†ï¼Œé‚£å¹²è„†è‡ªå·±å®ç°ä¸€ä¸ªä¼ªæœ¬åœ°ç¨‹åºå¥½äº†ã€‚

# å®ç°

ç®€å•å®ç°çš„pythonä»£ç å¦‚ä¸‹ï¼Œ

```python
import os
import logging
import requests
import nativemessaging

root = "C:\\Users\\pc\\Desktop"

log = logging.getLogger("log")
log.setLevel(level = logging.INFO)
formatter = logging.Formatter("[%(asctime)s] %(message)s")
file_handler = logging.FileHandler("main.log", mode="a")
file_handler.setFormatter(formatter)
log.addHandler(file_handler)

# å‘é€æ¶ˆæ¯
def send_msg(msg):
    encode_msg = nativemessaging.encode_message(msg)
    nativemessaging.send_message(encode_msg)

# å‘é€ä¸‹è½½æˆåŠŸæ¶ˆæ¯
def response_download_success(msg, filename):
    data = {"type":msg["type"], "filename":filename, "taskFilename":msg["filename"], "failed":False}
    send_msg(data)

# å‘é€ä¸‹è½½å¤±è´¥æ¶ˆæ¯    
def response_download_failed(msg, filename, errmsg):
    data = {"type":msg["type"], "filename":filename, "taskFilename":msg["filename"], "failed":True, "errmsg": errmsg}
    send_msg(data)

def http_download(msg):
    url = msg["url"]
    timeout = msg["timeout"]
    try:
        req = requests.get(url = url, timeout = timeout)
        if req.status_code == 200:
            return req.content
    except Exception:
        log.info("download %s failed", url)
    return b''
    
# ä¿å­˜æ–‡æœ¬
def download_text(msg):
    path = os.path.join(root, msg["filename"])
    if msg["taskType"] == "mainFileTask":
        dir = os.path.dirname(path)
        if not os.path.isdir(dir):
            os.makedirs(dir)
        content = msg["text"]
        with open(path, "w", encoding="utf8") as f:
            f.write(content)
        response_download_success(msg, path)
    elif msg["taskType"] == "infoFileTask":
        response_download_success(msg, path)
    else:
        response_download_success(msg, path)

# ä¿å­˜urlï¼ˆå›¾ç‰‡ï¼‰
def download_url(msg):
    content = http_download(msg)
    path = os.path.join(root, msg["filename"])
    if content:
        dir = os.path.dirname(path)
        if not os.path.isdir(dir):
            os.makedirs(dir)
        with open(path, "wb") as f:
            f.write(content)
        response_download_success(msg, path)
    else:
        response_download_failed(msg, path, "downlaod %s failed" %path)

while True:
    # å¾ªç¯æ¥æ”¶æ¶ˆæ¯
    msg = nativemessaging.get_message()
    log.info(str(msg))
    if msg["type"] == "get.version":
        send_msg({"type": msg['type'], "version": "0.2.2"})
    if msg["type"] == "get.downloadFolder":
        send_msg({"type": msg['type'], "downloadFolder": root})
    if msg["type"] == "download.text":
        download_text(msg)
    if msg["type"] == "download.url":
        download_url(msg)
```

å°†ç¨‹åºä¿å­˜æˆ`main.py`ï¼Œä¹‹åä¿®æ”¹æœ¬åœ°ç¨‹åºç›®å½•ä¸­çš„`app_loader.bat`ä¸­çš„å‘½ä»¤ä¸º`python "%~dp0/main.py" %*`ã€‚é‡å¯æµè§ˆå™¨è¿è¡Œï¼Œå…ˆæŸ¥çœ‹è®¾ç½®ä¸­æœ¬åœ°ç¨‹åºçš„çŠ¶æ€æ˜¯å¦æ­£å¸¸ã€‚æ­£å¸¸çš„è¯ï¼Œä¾¿å¯æ­£å¸¸å‰ªè—ç½‘é¡µã€‚

ç”±äºè‡ªå·±æ˜¯ä¸ºäº†ç»™å‰ªè—ä¸‹æ¥çš„ç»“æœè¿›è¡Œè‡ªå®šä¹‰å¤„ç†ï¼Œå› æ­¤å¹¶ä¸éœ€è¦åˆ é™¤å‰ªè—ç»“æœä»¥åŠåˆ·æ–°å†å²åŠŸèƒ½ï¼Œæ‰€ä»¥ä¸Šé¢çš„ä»£ç ä¸­å¹¶æœªå®ç°è¿™äº›åŠŸèƒ½ã€‚

æ¥ä¸‹æ¥åªéœ€åœ¨ä¸‹è½½æ–‡æœ¬å‡½æ•°é‚£é‡Œæ·»åŠ è‡ªå·±æƒ³è¦çš„è‡ªå®šä¹‰é€»è¾‘å°±è¡Œäº†ï¼Œæ¯”å¦‚æŒ‰ç…§è‡ªå·±çš„æƒ³æ³•è®¾ç½®ç›®å½•ç»“æ„ï¼Œæˆ–æ˜¯å¯¹ä¸‹è½½ä¸‹æ¥çš„æ–‡æœ¬è¿›è¡Œä¸€äº›ä¿®æ”¹åå†è¿›è¡Œä¿å­˜ç­‰ã€‚è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œæœ¬åœ°ç¨‹åºä¿å­˜ç½‘é¡µæ—¶ï¼Œç½‘é¡µä¸­çš„å›¾ç‰‡æ˜¯éœ€è¦ç”±æœ¬åœ°ç¨‹åºé‡æ–°ä¸‹è½½çš„ï¼Œè¿™ä¸ªå¯èƒ½ä¼šå› å„ç§åŸå› å¯¼è‡´ä¸‹è½½å¤±è´¥ï¼Œä¹‹å‰å·²ç»é—®è¿‡ä½œè€…æ˜¯å¦ä¼šæ”¯æŒè·å–æµè§ˆå™¨ä¸­ç¼“å­˜çš„å›¾ç‰‡ï¼Œä½œè€…è¡¨ç¤ºåç»­ä¼šåšçš„ï¼ˆå‚è§[issue 103](https://github.com/mika-cn/maoxian-web-clipper/issues/103)ï¼‰ï¼ŒæœŸå¾…æ–°ç‰ˆæœ¬ğŸ˜ã€‚

# æ€»ç»“

è‡ªå·±å¯¹MaoXianè¿™ä¸ªæ’ä»¶è¿˜æ˜¯å¾ˆæ»¡æ„çš„ï¼Œå‰ªè—æ•ˆæœå¥½ï¼ŒåŒæ—¶è¿˜å¯ä»¥è‡ªå·±æ¨¡æ‹Ÿå®ç°æœ¬åœ°ç¨‹åºï¼Œè¿›è€Œæ»¡è¶³è‡ªå·±å®šåˆ¶åŒ–çš„éœ€æ±‚ã€‚å¦‚æœå“ªå¤©è‡ªå·±ä¸ç”¨å°è±¡ç¬”è®°äº†ï¼Œå¯ä»¥è‡ªå·±å®ç°ä¸€ä¸ªç½‘é¡µå¤‡ä»½æœåŠ¡ï¼Œæ­å»ºåœ¨è‡ªå·±çš„æœåŠ¡å™¨ä¸Šï¼Œä¸è‡ªå·±çš„ä¼ªæœ¬åœ°ç¨‹åºä»¥åŠMaoXianæ’ä»¶è¿›è¡Œè”åŠ¨ğŸ˜‚ã€‚

# å‚è€ƒæ–‡ç« 

1. [Native Messaging](https://developer.chrome.com/extensions/nativeMessaging)
2. [pypi nativemessaging](https://pypi.org/project/nativemessaging/)